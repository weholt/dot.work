######################################################################
# SMART ALPINE AGENT IMAGE
#
# Feature flags (set to 1 to enable):
#
#   ENABLE_GH=1            → Install GitHub CLI (requires glibc)
#   ENABLE_NODE=1          → Install Node.js 20
#   ENABLE_NODE_TOOLS=1    → Install Gemini CLI, Copilot CLI, Claude Code, opencode-ai
#   ENABLE_PY_EXTRAS=1     → pip setuptools/wheel/uv or other Python deps
#
# Examples:
#
# Minimal Python + Node (no gh):
#   docker build -t agent --build-arg ENABLE_NODE=1 -f Dockerfile.smart-alpine .
#
# Full-featured all-tools:
#   docker build -t agent \
#       --build-arg ENABLE_GH=1 \
#       --build-arg ENABLE_NODE=1 \
#       --build-arg ENABLE_NODE_TOOLS=1 \
#       --build-arg ENABLE_PY_EXTRAS=1 \
#       -f Dockerfile.smart-alpine .
######################################################################

FROM alpine:3.20 AS base

ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Etc/UTC

######################################################################
# CORE SYSTEM PACKAGES (always installed)
######################################################################
RUN apk add --no-cache \
    bash \
    python3 \
    py3-pip \
    git \
    openssh-client \
    curl \
    wget \
    tar \
    ca-certificates

WORKDIR /workspace
ENTRYPOINT ["/bin/bash"]


######################################################################
# OPTIONAL: PYTHON EXTRAS (uv, setuptools, wheel, etc.)
######################################################################
ARG ENABLE_PY_EXTRAS=0
RUN if [ "$ENABLE_PY_EXTRAS" = "1" ]; then \
      echo "Installing Python extras..."; \
      pip install --no-cache-dir --upgrade pip setuptools wheel uv --break-system-packages; \
    else \
      echo "Skipping Python extras."; \
    fi


######################################################################
# OPTIONAL: NODE.JS 20
######################################################################
ARG ENABLE_NODE=0
RUN if [ "$ENABLE_NODE" = "1" ]; then \
      echo "Installing Node.js 20..."; \
      apk add --no-cache nodejs npm; \
    else \
      echo "Skipping Node.js."; \
    fi


######################################################################
# OPTIONAL: GLIBC LAYER (needed for GitHub CLI & some Node binaries)
######################################################################
FROM base AS glibc-builder

ARG ENABLE_GH=0
ENV GLIBC_VERSION="2.35-r0"

RUN if [ "$ENABLE_GH" = "1" ]; then \
      echo "Installing glibc compatibility layer..."; \
      wget -q -O /etc/apk/keys/sgerrand.rsa.pub https://alpine-pkgs.sgerrand.com/sgerrand.rsa.pub && \
      wget -q https://github.com/sgerrand/alpine-pkg-glibc/releases/download/${GLIBC_VERSION}/glibc-${GLIBC_VERSION}.apk && \
      wget -q https://github.com/sgerrand/alpine-pkg-glibc/releases/download/${GLIBC_VERSION}/glibc-bin-${GLIBC_VERSION}.apk && \
      apk add --no-cache glibc-${GLIBC_VERSION}.apk glibc-bin-${GLIBC_VERSION}.apk && \
      rm -f glibc*.apk; \
    else \
      echo "Skipping glibc layer."; \
    fi


######################################################################
# OPTIONAL: GITHUB CLI
######################################################################
FROM glibc-builder AS gh-builder

ARG ENABLE_GH=0
RUN if [ "$ENABLE_GH" = "1" ]; then \
      echo "Installing GitHub CLI (gh)..."; \
      wget -q https://github.com/cli/cli/releases/latest/download/gh_$(uname -m | sed 's/x86_64/amd64/')_linux.tar.gz && \
      tar -xzf gh_*_linux.tar.gz && \
      mv gh_*_linux/bin/gh /usr/local/bin/gh && \
      rm -rf gh_*_linux*; \
    else \
      echo "Skipping GitHub CLI."; \
    fi


######################################################################
# OPTIONAL: NODE-BASED LLM TOOLS
######################################################################
FROM gh-builder AS node-tools

ARG ENABLE_NODE=0
ARG ENABLE_NODE_TOOLS=0

RUN if [ "$ENABLE_NODE" = "1" ] && [ "$ENABLE_NODE_TOOLS" = "1" ]; then \
      echo "Installing Node-based LLM tools..."; \
      npm install -g \
        @google/gemini-cli \
        @githubnext/github-copilot-cli \
        @anthropic-ai/claude-code \
        opencode-ai; \
    else \
      echo "Skipping Node.js LLM tools."; \
    fi


######################################################################
# FINAL IMAGE — copies only what is needed
######################################################################
FROM base AS final

ARG ENABLE_NODE=0
ARG ENABLE_GH=0
ARG ENABLE_NODE_TOOLS=0
ARG ENABLE_PY_EXTRAS=0

######################################################################
# Copy: glibc if enabled
######################################################################
RUN --mount=type=bind,from=glibc-builder,target=/glibc-src \
    if [ "$ENABLE_GH" = "1" ]; then \
      if [ -d /glibc-src/usr/glibc-compat ]; then \
        cp -r /glibc-src/usr/glibc-compat /usr/glibc-compat && \
        cp /glibc-src/lib/ld-linux-x86-64.so.2 /lib/ld-linux-x86-64.so.2 && \
        cp /glibc-src/lib/libc.so.6 /lib/libc.so.6; \
      fi; \
    fi

######################################################################
# Copy: Node.js if enabled
######################################################################
RUN --mount=type=bind,from=node-tools,target=/node-src \
    if [ "$ENABLE_NODE" = "1" ]; then \
      if [ -f /node-src/usr/bin/node ]; then \
        cp /node-src/usr/bin/node /usr/bin/node && \
        cp /node-src/usr/bin/npm /usr/bin/npm && \
        cp -r /node-src/usr/lib/node_modules /usr/lib/node_modules; \
      fi; \
    fi

ENV PATH="/usr/lib/node_modules/.bin:${PATH}"

######################################################################
# Copy: GitHub CLI if enabled
######################################################################
RUN --mount=type=bind,from=gh-builder,target=/gh-src \
    if [ "$ENABLE_GH" = "1" ]; then \
      if [ -f /gh-src/usr/local/bin/gh ]; then \
        cp /gh-src/usr/local/bin/gh /usr/local/bin/gh; \
      fi; \
    fi

WORKDIR /workspace
ENTRYPOINT ["/bin/bash"]
