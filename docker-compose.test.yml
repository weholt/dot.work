# Docker Compose configuration for running dot-work tests with memory limits
# Usage: docker-compose -f docker-compose.test.yml up --abort-on-container-exit
#        docker-compose -f docker-compose.test.yml run --rm test

services:
  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    image: dot-work-test:latest
    container_name: dot-work-test-runner

    # Memory limits (4GB limit as requested)
    mem_limit: 4g
    mem_reservation: 2g
    memswap_limit: 4g

    # CPU limits (optional, adjust as needed)
    # cpus: '2.0'

    # Environment variables
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - TEST_MEMORY_LIMIT=4GB

    # Volume mounts
    volumes:
      # Mount test logs directory to host for persistence
      - ./test_logs:/app/test_logs

    # Working directory
    working_dir: /app

    # Command to run tests (can be overridden)
    command: >
      sh -c "echo 'Starting tests with 4GB memory limit...' &&
             uv run pytest tests/ -v --tb=short --strict-markers &&
             echo 'Tests completed successfully'"

    # Stop the container after tests complete
    restart: "no"

  # Service for running only unit tests
  test-unit:
    build:
      context: .
      dockerfile: Dockerfile.test
    image: dot-work-test:latest
    container_name: dot-work-unit-test-runner

    mem_limit: 4g
    mem_reservation: 2g
    memswap_limit: 4g

    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1

    volumes:
      - ./test_logs:/app/test_logs

    working_dir: /app

    command: >
      sh -c "echo 'Starting UNIT tests with 4GB memory limit...' &&
             uv run pytest tests/unit -v --tb=short --strict-markers &&
             echo 'Unit tests completed successfully'"

    restart: "no"
    profiles:
      - unit

  # Service for running only integration tests
  test-integration:
    build:
      context: .
      dockerfile: Dockerfile.test
    image: dot-work-test:latest
    container_name: dot-work-integration-test-runner

    mem_limit: 4g
    mem_reservation: 2g
    memswap_limit: 4g

    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1

    volumes:
      - ./test_logs:/app/test_logs

    working_dir: /app

    command: >
      sh -c "echo 'Starting INTEGRATION tests with 4GB memory limit...' &&
             uv run pytest tests/integration -v --tb=short --strict-markers &&
             echo 'Integration tests completed successfully'"

    restart: "no"
    profiles:
      - integration

  # Service for running a specific test (use with docker-compose run)
  test-single:
    build:
      context: .
      dockerfile: Dockerfile.test
    image: dot-work-test:latest

    mem_limit: 4g
    mem_reservation: 2g
    memswap_limit: 4g

    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - TEST_FILE=${TEST_FILE:-}

    volumes:
      - ./test_logs:/app/test_logs

    working_dir: /app

    command: >
      sh -c "if [ -z '$$TEST_FILE' ]; then
               echo 'Error: TEST_FILE environment variable must be set';
               exit 1;
             fi;
             echo 'Running single test: $$TEST_FILE';
             uv run pytest $$TEST_FILE -v --tb=long --strict-markers"

    restart: "no"
    profiles:
      - single
